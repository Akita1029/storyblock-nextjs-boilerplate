/*!
 * storyblok-js-client v4.5.2
 * Universal JavaScript SDK for Storyblok's API
 * (c) 2020-2022 Stobylok Team
 */
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("axios"));function s(e){return"number"==typeof e&&(e==e&&e!==1/0&&e!==-1/0)}function r(e,t,r){if(!s(t))throw new TypeError("Expected `limit` to be a finite number");if(!s(r))throw new TypeError("Expected `interval` to be a finite number");var i=[],n=[],o=0,a=function(){o++;var t=setTimeout((function(){o--,i.length>0&&a(),n=n.filter((function(e){return e!==t}))}),r);n.indexOf(t)<0&&n.push(t);var s=i.shift();s.resolve(e.apply(s.self,s.args))},l=function(){var e=arguments,s=this;return new Promise((function(r,n){i.push({resolve:r,reject:n,args:e,self:s}),o<t&&a()}))};return l.abort=function(){n.forEach(clearTimeout),n=[],i.forEach((function(e){e.reject(new throttle.AbortError)})),i.length=0},l}r.AbortError=function(){Error.call(this,"Throttled function aborted"),this.name="AbortError"};const i=function(e,t){if(!e)return null;let s={};for(let r in e){let i=e[r];t.indexOf(r)>-1&&null!==i&&(s[r]=i)}return s};var n={nodes:{horizontal_rule:()=>({singleTag:"hr"}),blockquote:()=>({tag:"blockquote"}),bullet_list:()=>({tag:"ul"}),code_block:e=>({tag:["pre",{tag:"code",attrs:e.attrs}]}),hard_break:()=>({singleTag:"br"}),heading:e=>({tag:`h${e.attrs.level}`}),image:e=>({singleTag:[{tag:"img",attrs:i(e.attrs,["src","alt","title"])}]}),list_item:()=>({tag:"li"}),ordered_list:()=>({tag:"ol"}),paragraph:()=>({tag:"p"})},marks:{bold:()=>({tag:"b"}),strike:()=>({tag:"strike"}),underline:()=>({tag:"u"}),strong:()=>({tag:"strong"}),code:()=>({tag:"code"}),italic:()=>({tag:"i"}),link(e){const t={...e.attrs},{linktype:s="url"}=e.attrs;return"email"===s&&(t.href=`mailto:${t.href}`),t.anchor&&(t.href=`${t.href}#${t.anchor}`,delete t.anchor),{tag:[{tag:"a",attrs:t}]}},styled:e=>({tag:[{tag:"span",attrs:e.attrs}]})}};class o{constructor(e){e||(e=n),this.marks=e.marks||[],this.nodes=e.nodes||[]}addNode(e,t){this.nodes[e]=t}addMark(e,t){this.marks[e]=t}render(e={}){if(e.content&&Array.isArray(e.content)){let t="";return e.content.forEach((e=>{t+=this.renderNode(e)})),t}return console.warn("The render method must receive an object with a content field, which is an array"),""}renderNode(e){let t=[];e.marks&&e.marks.forEach((e=>{const s=this.getMatchingMark(e);s&&t.push(this.renderOpeningTag(s.tag))}));const s=this.getMatchingNode(e);return s&&s.tag&&t.push(this.renderOpeningTag(s.tag)),e.content?e.content.forEach((e=>{t.push(this.renderNode(e))})):e.text?t.push(function(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},s=/[&<>"']/g,r=RegExp(s.source);return e&&r.test(e)?e.replace(s,(e=>t[e])):e}(e.text)):s&&s.singleTag?t.push(this.renderTag(s.singleTag," /")):s&&s.html&&t.push(s.html),s&&s.tag&&t.push(this.renderClosingTag(s.tag)),e.marks&&e.marks.slice(0).reverse().forEach((e=>{const s=this.getMatchingMark(e);s&&t.push(this.renderClosingTag(s.tag))})),t.join("")}renderTag(e,t){if(e.constructor===String)return`<${e}${t}>`;return e.map((e=>{if(e.constructor===String)return`<${e}${t}>`;{let s=`<${e.tag}`;if(e.attrs)for(let t in e.attrs){let r=e.attrs[t];null!==r&&(s+=` ${t}="${r}"`)}return`${s}${t}>`}})).join("")}renderOpeningTag(e){return this.renderTag(e,"")}renderClosingTag(e){if(e.constructor===String)return`</${e}>`;return e.slice(0).reverse().map((e=>e.constructor===String?`</${e}>`:`</${e.tag}>`)).join("")}getMatchingNode(e){if("function"==typeof this.nodes[e.type])return this.nodes[e.type](e)}getMatchingMark(e){if("function"==typeof this.marks[e.type])return this.marks[e.type](e)}}const a=(e=0,t=e)=>{const s=Math.abs(t-e)||0,r=e<t?1:-1;return((e=0,t)=>[...Array(e)].map(t))(s,((t,s)=>s*r+e))},l=(e,t,s)=>{const r=[];for(const i in e){if(!Object.prototype.hasOwnProperty.call(e,i))continue;const n=e[i],o=s?"":encodeURIComponent(i);let a;a="object"==typeof n?l(n,t?t+encodeURIComponent("["+o+"]"):o,Array.isArray(n)):(t?t+encodeURIComponent("["+o+"]"):o)+"="+encodeURIComponent(n),r.push(a)}return r.join("&")};let c={},h={};module.exports=class{constructor(e,s){if(!s){let t=e.region?`-${e.region}`:"",r=!1===e.https?"http":"https";s=void 0===e.oauthToken?`${r}://api${t}.storyblok.com/v2`:`${r}://api${t}.storyblok.com/v1`}let i=Object.assign({},e.headers),n=5;void 0!==e.oauthToken&&(i.Authorization=e.oauthToken,n=3),void 0!==e.rateLimit&&(n=e.rateLimit),this.richTextResolver=new o(e.richTextSchema),"function"==typeof e.componentResolver&&this.setComponentResolver(e.componentResolver),this.maxRetries=e.maxRetries||5,this.throttle=r(this.throttledRequest,n,1e3),this.accessToken=e.accessToken,this.relations={},this.links={},this.cache=e.cache||{clear:"manual"},this.client=t.default.create({baseURL:s,timeout:e.timeout||0,headers:i,proxy:e.proxy||!1}),e.responseInterceptor&&this.client.interceptors.response.use((t=>e.responseInterceptor(t))),this.resolveNestedRelations=e.resolveNestedRelations||!0}setComponentResolver(e){this.richTextResolver.addNode("blok",(t=>{let s="";return t.attrs.body.forEach((t=>{s+=e(t.component,t)})),{html:s}}))}parseParams(e={}){return e.version||(e.version="published"),e.token||(e.token=this.getToken()),e.cv||(e.cv=h[e.token]),Array.isArray(e.resolve_relations)&&(e.resolve_relations=e.resolve_relations.join(",")),e}factoryParamOptions(e,t={}){return((e="")=>e.indexOf("/cdn/")>-1)(e)?this.parseParams(t):t}makeRequest(e,t,s,r){const i=this.factoryParamOptions(e,((e={},t=25,s=1)=>({...e,per_page:t,page:s}))(t,s,r));return this.cacheResponse(e,i)}get(e,t){let s=`/${e}`;const r=this.factoryParamOptions(s,t);return this.cacheResponse(s,r)}async getAll(e,t={},s){const r=t.per_page||25,i=`/${e}`,n=i.split("/");s=s||n[n.length-1];const o=await this.makeRequest(i,t,r,1),l=o.total?Math.ceil(o.total/r):1;return((e=[],t)=>e.map(t).reduce(((e,t)=>[...e,...t]),[]))([o,...await(async(e=[],t)=>Promise.all(e.map(t)))(a(1,l),(async e=>this.makeRequest(i,t,r,e+1)))],(e=>Object.values(e.data[s])))}post(e,t){let s=`/${e}`;return this.throttle("post",s,t)}put(e,t){let s=`/${e}`;return this.throttle("put",s,t)}delete(e,t){let s=`/${e}`;return this.throttle("delete",s,t)}getStories(e){return this.get("cdn/stories",e)}getStory(e,t){return this.get(`cdn/stories/${e}`,t)}setToken(e){this.accessToken=e}getToken(){return this.accessToken}_cleanCopy(e){return JSON.parse(JSON.stringify(e))}_insertLinks(e,t){const s=e[t];s&&"multilink"==s.fieldtype&&"story"==s.linktype&&"string"==typeof s.id&&this.links[s.id]?s.story=this._cleanCopy(this.links[s.id]):s&&"story"===s.linktype&&"string"==typeof s.uuid&&this.links[s.uuid]&&(s.story=this._cleanCopy(this.links[s.uuid]))}_insertRelations(e,t,s){if(s.indexOf(e.component+"."+t)>-1)if("string"==typeof e[t])this.relations[e[t]]&&(e[t]=this._cleanCopy(this.relations[e[t]]));else if(e[t].constructor===Array){let s=[];e[t].forEach((e=>{this.relations[e]&&s.push(this._cleanCopy(this.relations[e]))})),e[t]=s}}_insertAssetsRelations(e,t){t.forEach((t=>{e.id===t.id&&(e.original=t,e.original.filename=e.filename,e.original.filename=e.original.filename.includes("https://s3.amazonaws.com/")?e.original.filename:e.original.filename.replace("https://","https://s3.amazonaws.com/"),delete e.original.s3_filename)}))}iterateTree(e,t){let s=e=>{if(null!=e)if(e.constructor===Array)for(let t=0;t<e.length;t++)s(e[t]);else if(e.constructor===Object){if(e._stopResolving)return;for(let r in e)e.component&&e._uid||"link"===e.type?(this._insertRelations(e,r,t),this._insertLinks(e,r)):"id"in e&&"asset"===e.fieldtype&&this._insertAssetsRelations(e,t),s(e[r])}};s(e.content)}async resolveLinks(e,t){let s=[];if(e.link_uuids){const r=e.link_uuids.length;let i=[];const n=50;for(let t=0;t<r;t+=n){const s=Math.min(r,t+n);i.push(e.link_uuids.slice(t,s))}for(let e=0;e<i.length;e++){(await this.getStories({per_page:n,language:t.language,version:t.version,by_uuids:i[e].join(",")})).data.stories.forEach((e=>{s.push(e)}))}}else s=e.links;s.forEach((e=>{this.links[e.uuid]={...e,_stopResolving:!0}}))}async resolveRelations(e,t){let s=[];if(e.rel_uuids){const r=e.rel_uuids.length;let i=[];const n=50;for(let t=0;t<r;t+=n){const s=Math.min(r,t+n);i.push(e.rel_uuids.slice(t,s))}for(let e=0;e<i.length;e++){(await this.getStories({per_page:n,language:t.language,version:t.version,by_uuids:i[e].join(",")})).data.stories.forEach((e=>{s.push(e)}))}}else s=e.rels;s.forEach((e=>{this.relations[e.uuid]={...e,_stopResolving:!0}}))}async resolveStories(e,t){let s=[];if(void 0!==t.resolve_relations&&t.resolve_relations.length>0&&(e.rels||e.rel_uuids)&&(s=t.resolve_relations.split(","),await this.resolveRelations(e,t)),["1","story","url"].indexOf(t.resolve_links)>-1&&(e.links||e.link_uuids)&&await this.resolveLinks(e,t),this.resolveNestedRelations)for(const e in this.relations)this.iterateTree(this.relations[e],s);e.story?this.iterateTree(e.story,s):e.stories.forEach((e=>{this.iterateTree(e,s)}))}resolveAssetsRelations(e){const{assets:t,stories:s,story:r}=e;if(s)for(const e of s)this.iterateTree(e,t);else{if(!r)return e;this.iterateTree(r,t)}}cacheResponse(e,t,s){return void 0===s&&(s=0),new Promise((async(r,i)=>{let n=l({url:e,params:t}),o=this.cacheProvider();if("auto"===this.cache.clear&&"draft"===t.version&&await this.flushCache(),"published"===t.version&&"/cdn/spaces/me"!=e){const e=await o.get(n);if(e)return r(e)}try{let s=await this.throttle("get",e,{params:t,paramsSerializer:e=>l(e)}),a={data:s.data,headers:s.headers};if(a.data.assets&&a.data.assets.length&&this.resolveAssetsRelations(a.data),a=Object.assign({},a,{perPage:s.headers["per-page"]?parseInt(s.headers["per-page"]):0,total:s.headers["per-page"]?parseInt(s.headers.total):0}),200!=s.status)return i(s);(a.data.story||a.data.stories)&&await this.resolveStories(a.data,t),"published"===t.version&&"/cdn/spaces/me"!=e&&o.set(n,a),a.data.cv&&("draft"==t.version&&h[t.token]!=a.data.cv&&this.flushCache(),h[t.token]=a.data.cv),r(a)}catch(n){if(n.response&&429===n.response.status&&(s+=1)<this.maxRetries)return console.log(`Hit rate limit. Retrying in ${s} seconds.`),await(a=1e3*s,new Promise((e=>setTimeout(e,a)))),this.cacheResponse(e,t,s).then(r).catch(i);i(n)}var a}))}throttledRequest(e,t,s){return this.client[e](t,s)}cacheVersions(){return h}cacheVersion(){return h[this.accessToken]}setCacheVersion(e){this.accessToken&&(h[this.accessToken]=e)}cacheProvider(){return"memory"===this.cache.type?{get:e=>c[e],getAll:()=>c,set(e,t){c[e]=t},flush(){c={}}}:{get(){},getAll(){},set(){},flush(){}}}async flushCache(){return await this.cacheProvider().flush(),this}};
